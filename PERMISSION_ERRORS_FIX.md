# תיקון שגיאות Permission Denied ב-Firestore

## 🔍 הבעיה שזוהתה

האפליקציה הייתה מקבלת שגיאות `permission-denied` בעת ניסיון להאזין לשינויים ב-Firestore, במיוחד עבור:
1. **Document listeners** - האזנה למסמכים בודדים
2. **CleaningTask listeners** - האזנה למשימות ניקוי

## 🛠️ התיקונים שבוצעו

### 1. שיפור הטיפול בשגיאות ב-`firestore-sdk-service.ts`
- הוספת לוגים מפורטים יותר לשגיאות permission-denied
- הוספת מידע דיבאג על המשתמש הנוכחי
- הוספת הסברים על הסיבות האפשריות לשגיאה

### 2. שיפור הטיפול בשגיאות ב-`store.ts`
- הוספת לוגים מפורטים לשגיאות permission-denied
- הוספת מידע על המשתמש והדירה הנוכחית
- שיפור הודעות השגיאה

### 3. הוספת בדיקות לפני הפעלת listeners
- יצירת פונקציה `_validateAuthAndApartmentContext()` לבדיקת מצב האימות
- בדיקה שהמשתמש מחובר
- בדיקה שיש לו ID token תקין
- בדיקה שהוא קשור לדירה
- בדיקה שהדירה המקומית תואמת לדירה של המשתמש

### 4. עדכון קריאות לפונקציות
- הפיכת `startCleaningTaskListener` לפונקציה async
- עדכון הקריאות ב-`CleaningScheduleSection.tsx`
- הוספת טיפול בשגיאות

### 5. יצירת כללי אבטחה של Firestore
- יצירת קובץ `firestore.rules` עם כללי אבטחה מפורטים
- יצירת קובץ `firestore.indexes.json` עם אינדקסים נדרשים
- עדכון `firebase.json` לכלול את הקבצים החדשים

## 📋 כללי האבטחה החדשים

הכללים החדשים מבטיחים:
- משתמשים יכולים לגשת רק לנתונים של הדירה שלהם
- כל גישה דורשת אימות תקין
- בדיקה שהמשתמש הוא חבר בדירה
- הגנה על כל הקולקציות: expenses, cleaningTasks, checklistItems, וכו'

## 🚀 הוראות הפעלה

### 1. פריסת כללי האבטחה
```bash
# וודא שאתה מחובר ל-Firebase
firebase login

# פרוס את כללי האבטחה והאינדקסים
firebase deploy --only firestore:rules,firestore:indexes
```

### 2. בדיקת התיקונים
1. הפעל את האפליקציה
2. בדוק שהלוגים מוצגים בצורה ברורה יותר
3. וודא שאין יותר שגיאות permission-denied מיותרות

### 3. בדיקת מצב האימות
האפליקציה תבדוק כעת:
- האם המשתמש מחובר
- האם יש לו ID token תקין
- האם הוא קשור לדירה
- האם הדירה המקומית תואמת לדירה של המשתמש

## 🔧 פתרון בעיות

### אם עדיין יש שגיאות permission-denied:

1. **בדוק שהמשתמש מחובר:**
   - וודא שהמשתמש עבר תהליך התחברות מלא
   - בדוק שיש ID token תקין

2. **בדוק שהמשתמש קשור לדירה:**
   - וודא ש-`current_apartment_id` מוגדר במסמך המשתמש
   - בדוק שהמשתמש הוא חבר בדירה ב-`apartmentMembers`

3. **בדוק את כללי האבטחה:**
   - וודא שכללי האבטחה נפרסו בהצלחה
   - בדוק ב-Firebase Console שהכללים פעילים

4. **בדוק את הלוגים:**
   - הלוגים החדשים יראו בדיוק מה הבעיה
   - חפש הודעות שמתחילות ב-🚫

## 📝 קבצים שעודכנו

- `src/services/firestore-sdk-service.ts` - שיפור טיפול בשגיאות
- `src/state/store.ts` - הוספת בדיקות ולוגים
- `src/components/CleaningScheduleSection.tsx` - עדכון קריאות async
- `firebase.json` - הוספת הגדרות Firestore
- `firestore.rules` - כללי אבטחה חדשים
- `firestore.indexes.json` - אינדקסים נדרשים

## ✅ תוצאות צפויות

לאחר הפעלת התיקונים:
1. **פחות שגיאות permission-denied** - האפליקציה תבדוק מצב לפני הפעלת listeners
2. **לוגים ברורים יותר** - יהיה קל יותר להבין מה הבעיה
3. **אבטחה משופרת** - כללי האבטחה החדשים מבטיחים גישה נכונה לנתונים
4. **ביצועים טובים יותר** - אינדקסים מותאמים לשאילתות

## 🔄 מעקב וניטור

לאחר הפעלת התיקונים, מומלץ לעקוב אחר:
1. הלוגים בקונסול - וודא שאין שגיאות permission-denied
2. Firebase Console - בדוק שהכללים פעילים
3. ביצועי האפליקציה - וודא שה-listeners עובדים כראוי
